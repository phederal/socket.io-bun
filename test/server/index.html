<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Socket.IO-Bun Live Tests</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				min-height: 100vh;
				color: #333;
			}

			.container {
				max-width: 1200px;
				margin: 0 auto;
				padding: 20px;
			}

			.header {
				text-align: center;
				margin-bottom: 40px;
				color: white;
			}

			.header h1 {
				font-size: 3rem;
				margin-bottom: 10px;
				text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
			}

			.header p {
				font-size: 1.2rem;
				opacity: 0.9;
			}

			.controls {
				background: white;
				padding: 20px;
				border-radius: 12px;
				box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
				margin-bottom: 30px;
				text-align: center;
			}

			.status {
				display: inline-block;
				padding: 8px 16px;
				border-radius: 20px;
				font-weight: 600;
				margin: 0 10px;
			}

			.status.connected {
				background: #d4edda;
				color: #155724;
				border: 1px solid #c3e6cb;
			}

			.status.disconnected {
				background: #f8d7da;
				color: #721c24;
				border: 1px solid #f5c6cb;
			}

			.status.testing {
				background: #fff3cd;
				color: #856404;
				border: 1px solid #ffeaa7;
			}

			button {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				border: none;
				padding: 12px 24px;
				border-radius: 8px;
				font-size: 16px;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s ease;
				margin: 10px;
			}

			button:hover {
				transform: translateY(-2px);
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
			}

			button:disabled {
				background: #ccc;
				cursor: not-allowed;
				transform: none;
			}

			.test-results {
				background: white;
				border-radius: 12px;
				box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
				overflow: hidden;
			}

			.summary {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				padding: 20px;
				text-align: center;
			}

			.summary.success {
				background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
			}

			.summary.failure {
				background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
			}

			.summary h2 {
				font-size: 2rem;
				margin-bottom: 10px;
			}

			.summary-stats {
				display: flex;
				justify-content: center;
				gap: 30px;
				margin-top: 15px;
			}

			.stat {
				text-align: center;
			}

			.stat-value {
				font-size: 2rem;
				font-weight: bold;
				display: block;
			}

			.stat-label {
				font-size: 0.9rem;
				opacity: 0.9;
			}

			.test-suite {
				border-bottom: 1px solid #eee;
			}

			.suite-header {
				padding: 20px;
				background: #f8f9fa;
				border-bottom: 1px solid #eee;
			}

			.suite-title {
				font-size: 1.5rem;
				font-weight: 600;
				margin-bottom: 5px;
			}

			.suite-stats {
				color: #666;
				font-size: 0.9rem;
			}

			.test-list {
				padding: 0;
			}

			.test-item {
				display: flex;
				align-items: center;
				padding: 15px 20px;
				border-bottom: 1px solid #f0f0f0;
				transition: background-color 0.2s;
			}

			.test-item:hover {
				background: #f8f9fa;
			}

			.test-item:last-child {
				border-bottom: none;
			}

			.test-status {
				width: 20px;
				height: 20px;
				border-radius: 50%;
				margin-right: 15px;
				display: flex;
				align-items: center;
				justify-content: center;
				font-weight: bold;
				font-size: 14px;
			}

			.test-status.passed {
				background: #28a745;
				color: white;
			}

			.test-status.failed {
				background: #dc3545;
				color: white;
			}

			.test-status.running {
				background: #ffc107;
				color: #000;
				animation: pulse 1.5s infinite;
			}

			@keyframes pulse {
				0% {
					opacity: 1;
				}
				50% {
					opacity: 0.5;
				}
				100% {
					opacity: 1;
				}
			}

			.test-name {
				flex-grow: 1;
				font-weight: 500;
			}

			.test-duration {
				color: #666;
				font-size: 0.9rem;
				margin-right: 10px;
			}

			.test-error {
				color: #dc3545;
				font-size: 0.8rem;
				margin-top: 5px;
				padding: 8px;
				background: #f8d7da;
				border-radius: 4px;
				border-left: 4px solid #dc3545;
			}

			.progress-bar {
				height: 4px;
				background: #e9ecef;
				margin-top: 10px;
				border-radius: 2px;
				overflow: hidden;
			}

			.progress-fill {
				height: 100%;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				width: 0%;
				transition: width 0.3s ease;
			}

			.logs {
				background: #f8f9fa;
				padding: 20px;
				font-family: 'Monaco', 'Courier New', monospace;
				font-size: 0.9rem;
				max-height: 300px;
				overflow-y: auto;
				border-top: 1px solid #eee;
			}

			.log-entry {
				margin: 2px 0;
				padding: 2px 0;
			}

			.log-info {
				color: #007bff;
			}
			.log-success {
				color: #28a745;
			}
			.log-error {
				color: #dc3545;
			}
			.log-warning {
				color: #ffc107;
			}

			.namespace-tests {
				margin-top: 20px;
				padding: 15px;
				background: #e3f2fd;
				border-radius: 8px;
				border-left: 4px solid #2196f3;
			}

			@media (max-width: 768px) {
				.container {
					padding: 10px;
				}

				.header h1 {
					font-size: 2rem;
				}

				.summary-stats {
					flex-direction: column;
					gap: 15px;
				}

				.test-item {
					flex-direction: column;
					align-items: flex-start;
				}

				.test-duration {
					margin-right: 0;
					margin-top: 5px;
				}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<h1>ðŸ”¥ Socket.IO-Bun</h1>
				<p>Real-time Testing Dashboard</p>
			</div>

			<div class="controls">
				<div id="connection-status" class="status disconnected">Disconnected</div>
				<button id="connect-btn">Connect & Run Tests</button>
				<button id="run-tests-btn" disabled>Run Tests Again</button>
				<button id="clear-btn">Clear Results</button>
			</div>

			<div id="test-results" class="test-results" style="display: none">
				<div id="summary" class="summary">
					<h2>Test Results</h2>
					<div class="summary-stats">
						<div class="stat">
							<span id="total-tests" class="stat-value">0</span>
							<span class="stat-label">Total Tests</span>
						</div>
						<div class="stat">
							<span id="passed-tests" class="stat-value">0</span>
							<span class="stat-label">Passed</span>
						</div>
						<div class="stat">
							<span id="failed-tests" class="stat-value">0</span>
							<span class="stat-label">Failed</span>
						</div>
						<div class="stat">
							<span id="test-duration" class="stat-value">0ms</span>
							<span class="stat-label">Duration</span>
						</div>
					</div>
					<div class="progress-bar">
						<div id="progress-fill" class="progress-fill"></div>
					</div>
				</div>

				<div id="test-suites"></div>

				<div class="logs">
					<div id="log-output"></div>
				</div>
			</div>

			<div class="namespace-tests">
				<h3>ðŸ§ª Additional Tests</h3>
				<p>
					The server also tests namespace functionality. All tests run automatically when
					you connect.
				</p>
				<ul>
					<li>âœ… Default namespace (/)</li>
					<li>âœ… Chat namespace (/chat)</li>
					<li>âœ… Room management</li>
					<li>âœ… Binary protocol</li>
					<li>âœ… Performance testing</li>
				</ul>
			</div>
		</div>

		<script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
		<script>
			let socket = null;
			let testResults = [];
			let currentProgress = 0;
			let totalTests = 0;

			const elements = {
				connectionStatus: document.getElementById('connection-status'),
				connectBtn: document.getElementById('connect-btn'),
				runTestsBtn: document.getElementById('run-tests-btn'),
				clearBtn: document.getElementById('clear-btn'),
				testResults: document.getElementById('test-results'),
				summary: document.getElementById('summary'),
				totalTests: document.getElementById('total-tests'),
				passedTests: document.getElementById('passed-tests'),
				failedTests: document.getElementById('failed-tests'),
				testDuration: document.getElementById('test-duration'),
				progressFill: document.getElementById('progress-fill'),
				testSuites: document.getElementById('test-suites'),
				logOutput: document.getElementById('log-output'),
			};

			function log(message, type = 'info') {
				const timestamp = new Date().toLocaleTimeString();
				const logEntry = document.createElement('div');
				logEntry.className = `log-entry log-${type}`;
				logEntry.textContent = `[${timestamp}] ${message}`;
				elements.logOutput.appendChild(logEntry);
				elements.logOutput.scrollTop = elements.logOutput.scrollHeight;
			}

			function updateConnectionStatus(connected) {
				elements.connectionStatus.textContent = connected ? 'Connected' : 'Disconnected';
				elements.connectionStatus.className = `status ${
					connected ? 'connected' : 'disconnected'
				}`;
				elements.connectBtn.textContent = connected ? 'Disconnect' : 'Connect & Run Tests';
				elements.runTestsBtn.disabled = !connected;
			}

			function updateProgress() {
				const progress = totalTests > 0 ? (currentProgress / totalTests) * 100 : 0;
				elements.progressFill.style.width = `${progress}%`;
			}

			function updateSummary(summary) {
				elements.totalTests.textContent = summary.totalTests;
				elements.passedTests.textContent = summary.totalPassed;
				elements.failedTests.textContent = summary.totalFailed;
				elements.testDuration.textContent = `${summary.totalDuration}ms`;

				elements.summary.className = `summary ${summary.success ? 'success' : 'failure'}`;
				elements.testResults.style.display = 'block';
			}

			function renderTestSuite(suite) {
				const suiteElement = document.createElement('div');
				suiteElement.className = 'test-suite';

				suiteElement.innerHTML = `
                <div class="suite-header">
                    <div class="suite-title">${suite.name}</div>
                    <div class="suite-stats">
                        ${suite.totalPassed} passed, ${suite.totalFailed} failed â€¢ ${
					suite.duration
				}ms
                    </div>
                </div>
                <div class="test-list" id="tests-${suite.name.replace(/\s+/g, '-')}"></div>
            `;

				const testList = suiteElement.querySelector('.test-list');
				suite.tests.forEach((test) => {
					const testElement = document.createElement('div');
					testElement.className = 'test-item';

					testElement.innerHTML = `
                    <div class="test-status ${test.passed ? 'passed' : 'failed'}">
                        ${test.passed ? 'âœ“' : 'âœ—'}
                    </div>
                    <div class="test-name">${test.name}</div>
                    <div class="test-duration">${test.duration}ms</div>
                `;

					if (!test.passed && test.error) {
						const errorElement = document.createElement('div');
						errorElement.className = 'test-error';
						errorElement.textContent = test.error;
						testElement.querySelector('.test-name').appendChild(errorElement);
					}

					testList.appendChild(testElement);
				});

				return suiteElement;
			}

			function connect() {
				if (socket && socket.connected) {
					socket.disconnect();
					return;
				}

				log('Connecting to test server...', 'info');

				socket = io('wss://localhost:8443', {
					path: '/ws',
					transports: ['websocket'],
					timeout: 10000,
					forceNew: true,
					autoConnect: true,
				});

				socket.on('connect', () => {
					log(`Connected with ID: ${socket.id}`, 'success');
					updateConnectionStatus(true);
				});

				socket.on('connect_error', (error) => {
					log(`Connection error: ${error.message}`, 'error');
					console.error('Full connection error:', error);
					updateConnectionStatus(false);
				});

				socket.on('disconnect', (reason) => {
					log(`Disconnected: ${reason}`, 'warning');
					updateConnectionStatus(false);
				});

				socket.on('test_ready', () => {
					log('Test server ready. Starting tests automatically...', 'info');
					console.log('ðŸ“¨ Received test_ready event from server');
					totalTests = 8; // Update total test count

					// Ð”Ð¾Ð±Ð°Ð²Ð¸Ð¼ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÑƒÑŽ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ Ð¸ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
					setTimeout(() => {
						console.log('ðŸ“¤ Sending start_tests to server');
						socket.emit('start_tests');
					}, 500);
				});

				socket.on('test_suite_start', (data) => {
					log(`Starting test suite: ${data.name}`, 'info');
					console.log('ðŸ“¨ Test suite start:', data);
					elements.connectionStatus.textContent = 'Running Tests';
					elements.connectionStatus.className = 'status testing';
				});

				socket.on('test_progress', (data) => {
					log(
						`Test: ${data.name} - ${data.status}`,
						data.status === 'passed' ? 'success' : 'error'
					);
					console.log('ðŸ“¨ Test progress:', data);
					currentProgress++;
					updateProgress();
				});

				socket.on('test_results', (data) => {
					log('Received test results', 'info');
					console.log('ðŸ“¨ Full test results:', data);
					testResults = data.suites;
					updateSummary(data.summary);

					elements.testSuites.innerHTML = '';
					data.suites.forEach((suite) => {
						elements.testSuites.appendChild(renderTestSuite(suite));
					});
				});

				socket.on('tests_complete', (summary) => {
					log(
						`Tests completed: ${summary.totalPassed}/${summary.totalTests} passed`,
						summary.success ? 'success' : 'error'
					);
					console.log('ðŸ“¨ Tests complete summary:', summary);
					updateConnectionStatus(true);
				});
			}

			function runTests() {
				if (socket && socket.connected) {
					log('Running tests again...', 'info');
					elements.testSuites.innerHTML = '';
					currentProgress = 0;
					console.log('ðŸ“¤ Manually sending start_tests to server');
					socket.emit('start_tests');
				}
			}

			function clearResults() {
				elements.testResults.style.display = 'none';
				elements.testSuites.innerHTML = '';
				elements.logOutput.innerHTML = '';
				testResults = [];
				currentProgress = 0;
				totalTests = 0;
				updateProgress();
				log('Results cleared', 'info');
			}

			// Event listeners
			elements.connectBtn.addEventListener('click', connect);
			elements.runTestsBtn.addEventListener('click', runTests);
			elements.clearBtn.addEventListener('click', clearResults);

			// Auto-connect on page load
			setTimeout(connect, 1000);
		</script>
	</body>
</html>
